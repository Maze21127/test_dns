Тестовое задание на позицию Junior Fullstack Python разработчик. 

Реализация через инъекцию зависимости для работы с БД.

- [Описание задачи](#описание-задачи)
- [Описание эксплуатации сервиса](#Описание-эксплуатации-сервиса)
  - [Установка и запуск](#установка-и-запуск)
    - [Production](#production)
    - [Dev](#dev)
  - [Работа с сервисом](#работа-с-сервисом)
    - [Документация](#документация)
      - [Города](#cities)
        - [Создать город](#создать-новый-город)
        - [Удалить все города](#удалить-все-города)
        - [Найти кратчайшее расстояние между двумя городами](#найти-кратчайшее-расстояние-между-двумя-городами-)
      - [Связи](#edges)
        - [Удалить все связи](#удалить-все-связи)
  - [Запуск тестов](#запуск-тестов)
- [Описание решения задачи](#описание-решения-задачи)

# Описание задачи
## FSP Service

FSP Service — это FastAPI приложение, которое помогает пользователю находить кратчайшее расстояние между городами.

Структура API может выглядеть так:

```
/cities/{city}/findShortestPath?to={targetCity}
```

Структура ответа:

```json
{
    
    "city": "City Name",
    "result":
        {
            "distance": 100,
            "targetCity": "Target City Name"
        }  
}
```


### Задача

* Обдумать способ хранения графа городов из `sample.txt` в Postgres;
* Реализовать выбранный подход и заполнить таблицы;
* Реализовать алгоритм поиска кратчайшего пути;
* Реализовать сервис с использованием FastAPI и SQLAlchemy.

### Требования

* Таблицы должны соответствовать DKNF;
* Сервис должен иметь несколько слабосвязных слоёв логики;
* Необходимо использовать Pydantic для формирования DTO и конфигурации приложения;
* Работу с БД организовать с использованием `starlette app.state`


### Ожидаемый результат

Репозиторий должен содержать:

* Исходный код;
* Dockerfile для сервиса;
* Docker-compose для работы сервиса и PostgreSQL;
* TestClient для проверки результатов работы алгоритма;
* README.md с описанием эксплуатации сервиса;
* README.md с описанием решения задачи и указанием причин выбора реализованного подхода.

# Описание эксплуатации сервиса
### Установка и запуск
- Клонирование репозитория
```bash
git clone ...
```
#### Production
- Создание файла .env
```bash
mv .env.dist .env 
```
- Установить DEV=True в файле .env

- Подготовка
  - Заполнить файл .env
  - Запустить команды
```bash
docker-compose build
docker-compose --profile prod
```
- Перейти по адресу http://127.0.0.1:8000/docs (порт из .env)

#### Dev
- Установить DEV=True в файле .env


- Подготовка
  - При необходимости изменить файл .env.dev
  - Запустить команды
```bash
docker-compose build
docker-compose --profile dev up
```
Данные команды поднимут тестовую базу данных

- Запустить миграции
```bash
alembic upgrade heads
```

- Запуск локального сервера
```bash
uvicorn app.main:app --reload 
```
- Перейти по адресу http://127.0.0.1:8000/docs

### Работа с сервисом
1. Сделать запрос на следующий адрес и добавить файл sample.txt
```bash
/api/cities/fromFile
```
Это загрузит в базу города и связи между ними.

### Документация
#### Cities
#### Получить список городов из базы данных.
```bash
GET /api/cities
```

#### Создать новый город
```bash
POST /api/cities
```
Тело запроса: 
```json
{
  "name": "Renton"
}
```
Возвращаемый тип:
```json
{
  "id": 0,
  "name": "Renton"
}
```

#### Удалить все города
Перед удалением может потребоваться удалить все связи.
```bash
DELETE /api/cities
```

#### Найти кратчайшее расстояние между двумя городами 
```bash
GET /api/cities/{cityFrom}/findShortestPath?to={cityTo}
```
Возвращаемый тип:
```json
{
  "city": "cityFrom",
  "result": {
    "distance": 0,
    "targetCity": "cityTo"
  }
}
```

#### Edges

#### Удалить все связи
```bash
DELETE /api/edges
```

### Запуск тестов
Для запуска тестов переменная окружения DEV должна быть True
```bash
export DEV=True
```
Запустить тестовую базу данных
```bash
docker-compose build
docker-compose --profile test up
```
Запуск
```bash
pytest
```
Будет создана тестовая база, загружены города из файла и проверен целевой маршрут.
Тесты:
- Расстояния от города А до города А должно равняться 0
- Расстояние от города А до города Б возвращает верный формат
- Статус-код ответа при несуществующих городах - 404
- 8 тестов на проверку кратчайшего пути между различными городами. Для проверки использовался Алгоритм Дейкстры.

# Описание решения задачи
#### Alembic / миграции
Для более удобной работы с созданием и обновлением таблиц используются миграции с применением инструмента Alembic.  

Возможно, для данного кейса это избыточно, я хотел показать, что знаком с данной технологией.  
На проектах масштабнее он мне сильно помогал.
#### .env / переменные окружения
Все чувствительные данные должны храниться только локально и не должны быть выгружены даже в приватный репозиторий. 

Так как данные для разработки и для тестирования в данном кейсе не являются "секретными", они намеренно были загружены в репозиторий. 
#### Работа с БД
В данном подходе для каждого запроса создается асинхронная сессия для работы с БД.

Все запросы выполнены с использованием SQLAlchemy.

Приложение разделено на несколько слоев. Напрямую с БД работают только DAL (Data Access Layer) классы.  
К ним обращаются функции в слое бизнес-логики. Эти функции вызываются из обработчиков запросов.


#### FastAPI Router
Используется для разделения приложения на разные"блоки".  

#### Pydantic
Используется для более удобной работы с разными объектами.  
Гораздо удобнее работать с типизированными объектами, чем с "сырыми" словарями/кортежами.